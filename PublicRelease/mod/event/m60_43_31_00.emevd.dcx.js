// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.5
// ==/EMEVD==

$Event(0, Default, function() {
    RegisterBonfire(1043310000, 1043311950, 0, 0, 0, 5);
    InitializeCommonEvent(0, 90005100, 76161, 76158, 1043311980, 77110, 3, 78110, 78111, 78112, 78113, 78114, 78115, 78116, 78117, 78118, 78119);
    //RegisterBonfire(1043310001, 1043311951, 0, 0, 0, 5);
    InitializeCommonEvent(0, 9005810, 1043300820, 76159, 1043310951, 1043311951, 1084227584);
    RegisterBonfire(1043310002, 1043311952, 0, 0, 0, 5);
    RegisterBonfire(1043310003, 1043311953, 0, 0, 0, 5);
    InitializeEvent(0, 1043312580, 0);
    InitializeCommonEvent(0, 900005610, 1043311650, 100, 800, 0);
    InitializeCommonEvent(1, 900005610, 1043311651, 100, 800, 0);
    InitializeCommonEvent(2, 900005610, 1043311652, 100, 800, 0);
    InitializeCommonEvent(3, 900005610, 1043311653, 100, 800, 0);
    InitializeCommonEvent(4, 900005610, 1043311654, 100, 800, 0);
    InitializeCommonEvent(5, 900005610, 1043311655, 100, 800, 0);
    InitializeCommonEvent(6, 900005610, 1043311656, 100, 800, 0);
    InitializeCommonEvent(7, 900005610, 1043311657, 100, 800, 0);
    InitializeCommonEvent(8, 900005610, 1043311658, 100, 800, 0);
    InitializeCommonEvent(0, 90005250, 1043310205, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310206, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310207, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310208, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310209, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310212, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310213, 1043312200, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310203, 1043312201, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310204, 1043312201, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310211, 1043312201, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310280, 1043312201, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310205, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310206, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310207, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310208, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310209, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310212, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310213, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310203, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310204, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310211, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310280, 1043312280, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310214, 1043312218, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310215, 1043312213, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310216, 1043312213, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310218, 1043312218, 0, -1);
    InitializeEvent(0, 1043312443, 1043310215, 1043312213);
    InitializeEvent(1, 1043312443, 1043310216, 1043312213);
    InitializeEvent(2, 1043312443, 1043310218, 1043312213);
    InitializeCommonEvent(0, 90005250, 1043310217, 1043312213, 1084227584, -1);
    InitializeCommonEvent(0, 90005250, 1043310220, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310221, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310222, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310223, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310224, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310225, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310226, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310227, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310228, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310229, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310230, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310231, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310232, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310233, 1043312223, 0, -1);
    //InitializeCommonEvent(0, 90005271, 1043310245, 0, -1);
    InitializeCommonEvent(0, 90005271, 1043310246, 0, -1);
    InitializeCommonEvent(0, 90005271, 1043310267, 0, -1);
    InitializeCommonEvent(0, 90005271, 1043310268, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310281, 1043312250, 0, -1);
    InitializeEvent(3, 1043312443, 1043310281, 1043312250);
    //InitializeCommonEvent(1, 90005271, 1043310271, 0, -1);
    InitializeCommonEvent(2, 90005271, 1043310272, 0, -1);
    InitializeCommonEvent(0, 90005251, 1043310255, 1084227584, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310256, 1043312256, 0, 3023);
    InitializeCommonEvent(0, 90005250, 1043310262, 1043312262, 1065353216, 3031);
    InitializeEvent(4, 1043312443, 1043310262, 1043312262);
    //InitializeCommonEvent(0, 90005271, 1043310264, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310285, 1043312285, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310269, 1043312285, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310270, 1043312285, 0, -1);
    InitializeEvent(0, 1043312242, 1043315240, 1043312242);
    InitializeEvent(0, 1043312223, 1043315223, 1043312223);
    InitializeCommonEvent(0, 90005250, 1043310304, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310305, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310306, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310307, 1043312220, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310311, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310312, 1043312223, 1077936128, 3025);
    InitializeCommonEvent(0, 90005250, 1043310313, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310314, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310315, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310316, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005271, 1043310352, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310351, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310353, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310354, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310355, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310356, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310357, 1043312223, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310400, 1043312400, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310401, 1043312400, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310402, 1043312400, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310403, 1043312403, 0, -1);
    InitializeCommonEvent(0, 90005260, 1043310405, 1043312403, 1084227584, 0, -1);
    InitializeCommonEvent(0, 90005201, 1043310420, 30005, 20005, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005200, 1043310430, 30000, 20000, 1043312430, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005250, 1043310434, 1043312430, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310440, 1043312442, 0, -1);
    InitializeCommonEvent(0, 90005250, 1043310441, 1043312442, 0, -1);
    InitializeCommonEvent(0, 90005251, 1043310442, 1084227584, 0, -1);
    InitializeCommonEvent(0, 90005501, 1043310510, 1043310511, 3, 1043311510, 1043311511, 1043311512, 1043310512);
    InitializeEvent(0, 1043312510, 0);
    if (EventFlag(57)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001270, 1065353216, 0, 1065353216);
    }
    if (EventFlag(56)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001260, 1065353216, 0, 1065353216);
    }
    if (EventFlag(55)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001250, 1065353216, 0, 1065353216);
    }
    if (EventFlag(54)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001240, 1065353216, 0, 1065353216);
    }
    if (EventFlag(53)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001230, 1065353216, 0, 1065353216);
    }
    if (EventFlag(52)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001220, 1065353216, 0, 1065353216);
    }
    if (EventFlag(51)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001210, 1065353216, 0, 1065353216);
    }
    if (EventFlag(50)) {
        InitializeCommonEvent(0, 90005695, 1043311600, 1043311600, 200, 0, 802001200, 1065353216, 0, 1065353216);
    }
    InitializeCommonEvent(0, 90005706, 1043310700, 930023, 0);
    InitializeCommonEvent(0, 90005704, 1043310705, 3401, 3400, 1043309201, 3);
    InitializeCommonEvent(0, 90005703, 1043310705, 3401, 3402, 1043309201, 3401, 3400, 3403, -1);
    InitializeCommonEvent(0, 90005702, 1043310705, 3403, 3400, 3403);
    InitializeEvent(0, 1043310705, 1043310705, 1043311700);
    InitializeCommonEvent(0, 90005750, 1043311701, 4110, 110620, 400061, 400061, 1043319208, 0);
    InitializeEvent(0, 1043310706, 0);
    InitializeEvent(0, 1043310707, 1043310705);
    InitializeEvent(0, 1043310708, 0);
    InitializeEvent(0, 1043312709, 1043310705, 1043311700);
    InitializeEvent(0, 1043312849, 0);
    
    // Tree Door Puzzle
    InitializeEvent(0, 1043301810, 0);
    InitializeEvent(0, 1043301811, 1043301815, 1043300720, 1043301840, 1043301841, 1043301842, 1043301843, 1043301844, 1043301845, 1043301846, 1043301847);
    InitializeEvent(1, 1043301811, 1043301816, 1043300721, 1043301830, 1043301831, 1043301832, 1043301833, 1043301834, 1043301835, 1043301836, 1043301837);
    
    // Inner Wall Golem
    InitializeEvent(0, 1043312345, 0);
    
    // Fire Balista
    InitializeEvent(0, 1043310330, 0);
    
    // Custom Killboxes
    InitializeCommonEvent(0, 9005999, 1043312350);
    InitializeCommonEvent(1, 9005999, 1043312351);
    InitializeCommonEvent(2, 9005999, 1043312352);
    InitializeCommonEvent(3, 9005999, 1043312353);
    InitializeCommonEvent(4, 9005999, 1043312354);
    
    // Madness cliff groundfire
    InitializeEvent(0, 1043310955, 1043312853);
    InitializeEvent(1, 1043310955, 1043312854);
    InitializeEvent(2, 1043310955, 1043312855);
    
    // Spire Chest Handler
    InitializeEvent(0, 1043313905, 0);
    
    // Madness Cliff Shrine Immunity
    InitializeEvent(0, 1043313906, 0);
    
    // Fundi NPC
    InitializeCommonEvent(0, 90005250, 1043310610, 1043312285, 0, -1); //Fundi NPC trigger box
    InitializeCommonEvent(0, 90005300, 1043310610, 1043310610, 105500, 0, 0); // Reward
});

$Event(50, Default, function() {
    SetCharacterBackreadState(1043310700, true);
    SetCharacterBackreadState(1043310705, true);
    InitializeEvent(0, 1043310519, 0);
    
    // - - - Morne Castle - - -
    InitializeEvent(0, 1043310877, 0); // Morne Tunnel Teleport Handler
    
    // - - - Madness Cliff - - -
    // Enemies
    InitializeEvent(0, 1043310790, 1043311520, 30002); // Makes Commoner play song
    InitializeEvent(0, 1043310340, 1043310340); // Make Troll jump
    InitializeCommonEvent(0, 20000343, 1043310340, 1043314340, 0); // Troll-Troll OTK
    InitializeCommonEvent(1, 20000343, 1043310341, 1043310340, 0); // Commoner-Troll OTK
    InitializeCommonEvent(2, 20000343, 1043310345, 1043312345, 1043310920); // Archer OTK
    
    // Shrine
    InitializeEvent(0, 1043312310, 1043310921); // Initialization
    InitializeEvent(0, 1043312312, 0); // Warp Behind Door
    InitializeEvent(0, 1043311711, 0); // Pocket Dimension Teleport
    InitializeEvent(0, 1043311712, 0); // Boss Init
    InitializeEvent(0, 1043310949, 0);
    InitializeEvent(0, 1043310950, 0); // Toggle shrine bullets based on range
    InitializeEvent(0, 1043312320, 1043310921, 0); // Bullet Madness + Scaling
    InitializeEvent(1, 1043312320, 1043310922, 0);
    InitializeEvent(2, 1043312320, 1043310923, 1);

    // Beach
    InitializeEvent(0, 1043311530, 1043311530, 0); // Bloated guys ambush
    InitializeEvent(1, 1043311530, 1043311531, 8);
    InitializeEvent(2, 1043311530, 1043311532, 4);
    InitializeEvent(3, 1043311530, 1043311533, 2);
    InitializeEvent(4, 1043311530, 1043311534, 6);
    InitializeEvent(5, 1043311530, 1043311535, 10);
    
    // Wall
    InitializeEvent(0, 1043311695, 0); // Does not open from this side msg 4 door
   
});



$Event(1043312443, Restart, function(X0_4, X4_4) {
    onlineChrSpArea = PlayerIsInOwnWorld()
        && ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.BluePhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
        && InArea(10000, X4_4);
    SetSpEffect(X0_4, 8080);
    WaitFixedTimeSeconds(0.4);
    RestartEvent();
});

$Event(1043312242, Restart, function(X0_4, X4_4) {
    ClearSpEffect(X0_4, 4800);
    SetSpEffect(X0_4, 4802);
    EndIf(EventFlag(1043312240));
    SetSpEffect(X0_4, 4800);
    WaitFor(
        ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && (HasDamageType(X0_4, 10000, DamageType.Unspecified)
                || HasDamageType(X0_4, 35000, DamageType.Unspecified)
                || HasDamageType(35000, X0_4, DamageType.Unspecified)
                || EntityInRadiusOfEntity(10000, X0_4, 10, 1)
                || EntityInRadiusOfEntity(35000, X0_4, 10, 1)
                || InArea(10000, X4_4)
                || InArea(35000, X4_4)));
    SetNetworkconnectedEventFlagID(1043312240, ON);
    ClearSpEffect(X0_4, 4800);
});

$Event(1043312223, Restart, function(X0_4, X4_4) {
    ClearSpEffect(X0_4, 4800);
    ClearSpEffect(X0_4, 5655);
    SetSpEffect(X0_4, 4802);
    EndIf(EventFlag(1043312223));
    SetSpEffect(X0_4, 4800);
    SetSpEffect(X0_4, 5655);
    WaitFor(
        ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && (HasDamageType(X0_4, 10000, DamageType.Unspecified)
                || HasDamageType(X0_4, 35000, DamageType.Unspecified)
                || HasDamageType(35000, X0_4, DamageType.Unspecified)
                || EntityInRadiusOfEntity(10000, X0_4, 10, 1)
                || EntityInRadiusOfEntity(35000, X0_4, 10, 1)
                || InArea(10000, X4_4)
                || InArea(35000, X4_4)));
    SetNetworkconnectedEventFlagID(1043312223, ON);
    ClearSpEffect(X0_4, 4800);
    ClearSpEffect(X0_4, 5655);
});

$Event(1043312510, Default, function() {
    InitializeCommonEvent(0, 90005500, 1043310510, 1043310511, 3, 1043311510, 1043311511, 1043313511, 1043311512, 1043313512, 1043312511, 1043312512, 1043310512, 1043310513, 0);
});

$Event(1043310519, Default, function() {
    EndIf(ThisEventSlot());
    SetEventFlagID(1043310510, OFF);
});

$Event(1043312580, Default, function() {
    RegisterLadder(1043310580, 1043310851, 1043311580);
    RegisterLadder(1043310582, 1043310853, 1043311582);
    RegisterLadder(1043310583, 1043310854, 1043311583);
    //RegisterLadder(1043310584, 1043310855, 1043311584);
    RegisterLadder(1043310586, 1043310857, 1043311586);
    RegisterLadder(1043310588, 1043310859, 1043311588);
    RegisterLadder(1043310590, 1043310861, 1043311590);
    RegisterLadder(1043310592, 1043310863, 1043311592);
    RegisterLadder(1043310594, 1043310865, 1043311594); // Madness Cliff Approach
    RegisterLadder(1043310596, 1043310867, 1043311596);
    RegisterLadder(1043310598, 1043310869, 1043311598);
    RegisterLadder(1043310602, 1043310873, 1043311602);
    RegisterLadder(1043310603, 1043310874, 1043311603); // Morne Town Tower
    RegisterLadder(1043310604, 1043310875, 1043311604);
    RegisterLadder(1043310605, 1043310876, 1043311605);
    RegisterLadder(1043310606, 1043310878, 1043311606); // Wall Tower Ladder
    RegisterLadder(1043310607, 1043310879, 1043311607);
    RegisterLadder(1043310608, 1043310880, 1043311608);
    RegisterLadder(1043310609, 1043310882, 1043311609);
    RegisterLadder(1043310611, 1043310884, 1043311610);
    RegisterLadder(1043310612, 1043310886, 1043311612);
    InitializeCommonEvent(0, 90005520, 1043310576, 1043311601, 1043311601, 1043310881); // Kick Ladder
    InitializeCommonEvent(0, 90005520, 1043310577, 1043311584, 1043310584, 1043310855); // Kick Ladder
    EndEvent();
});

$Event(1043313700, Restart, function(X0_4) {
    SetCharacterBackreadState(X0_4, false);
    EnableCharacter(X0_4);
    ForceAnimationPlayback(X0_4, 30023, false, false, false);
    EndEvent();
});

$Event(1043310705, Restart, function(X0_4, X4_4) {
    DisableNetworkSync();
    WaitFixedTimeFrames(1);
    if (PlayerIsInOwnWorld()) {
        if (EventFlag(3400)) {
            SetEventFlagID(1043319202, OFF);
        }
    }
L10:
    GotoIf(L5, EventFlag(3405));
    GotoIf(L7, EventFlag(3407));
    DisableCharacter(X0_4);
    SetCharacterBackreadState(X0_4, true);
    WaitFor(EventFlag(3405) || EventFlag(3407));
    RestartEvent();
L5:
L7:
    GotoIf(L0, EventFlag(3400));
    GotoIf(L1, EventFlag(3401));
    GotoIf(L3, EventFlag(3403));
L0:
    EnableCharacter(X0_4);
    SetCharacterBackreadState(X0_4, false);
    ForceAnimationPlayback(X0_4, 90100, false, false, false);
    IssueShortWarpRequest(X0_4, TargetEntityType.Area, 1043312700, -1);
    RequestAssetRestoration(X4_4);
    EnableAssetInvunerability(X4_4);
    Goto(L20);
L1:
    EnableCharacter(X0_4);
    SetCharacterBackreadState(X0_4, false);
    SetCharacterTeamType(X0_4, TeamType.HostileNPC);
    Goto(L20);
L3:
    DisableCharacter(X0_4);
    SetCharacterBackreadState(X0_4, true);
    if (PlayerIsInOwnWorld()) {
        SetEventFlagID(1043319208, ON);
    }
    Goto(L20);
L20:
    WaitFor(!EventFlag(3405) && !EventFlag(3407));
    RestartEvent();
});

$Event(1043310706, Default, function() {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(ThisEventSlot());
    WaitFor(EventFlag(3405) && (EventFlag(1043319206) || EventFlag(3403)));
    SetEventFlagID(3398, ON);
    EndIf(!(EventFlag(1043319206) && EventFlag(1043300800)));
    SetEventFlagID(3418, ON);
});

$Event(1043310707, Default, function(X0_4) {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(AnyBatchEventFlags(3406, 3417));
    WaitFor(
        EventFlag(1043319206) && EventFlag(3405) && !EntityInRadiusOfEntity(10000, X0_4, 100, 1));
    SetEventFlagID(3418, ON);
});

$Event(1043310708, Default, function() {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(1043300800));
    WaitFor(EventFlag(1043300800) && EventFlag(3406));
    SetEventFlagID(3418, ON);
});

$Event(1043312709, Restart, function(X0_4, X4_4) {
    if (!ThisEventSlot()) {
        WaitFor(
            !CharacterHasSpEffect(X0_4, 9624)
                && CharacterBackreadStatus(X0_4)
                && EventFlag(3401)
                && (EventFlag(3405) || EventFlag(3407))
                && PlayerIsInOwnWorld());
    }
L1:
    DisableAssetInvunerability(X4_4);
    RequestAssetDestruction(X4_4, 0);
});

// - - - Madness Cliff - - -
// Used EventFlagIDs:
const TrollOTK = 1043314340 // One time kill handler for jumping troll
const BossEncountered = 1043310910 // Has started the bossfight once before
const ShrineComplete = 1043310920 // Has killed the boss and completed the shrine

// Arena Cloud Balancing Values
const DisableCloudPhase = 0 // [0/1] If you dont want the second phase to have the cloud mechanic, you can disable it here
const CloudCount = 9 // Also needs map edits adding more SFX with the established EntityID setup

// Makes commoner play song
$Event(1043310790, Restart, function(X0_4, X4_4) {
    DisableCharacterAI(X0_4);
    ForceAnimationPlayback(X0_4, X4_4, true, true, false);
});

// Troll Jump
$Event(1043310340, Restart, function(X0_4) {
    EndIf(EventFlag(TrollOTK));
    SetCharacterAIState(X0_4, Disabled);
    WaitFor(
        HasDamageType(1043310340, 0, DamageType.Unspecified)
            || CharacterHasStateInfo(X0_4, 436)
            || CharacterHasStateInfo(X0_4, 2)
            || CharacterHasStateInfo(X0_4, 5)
            || CharacterHasStateInfo(X0_4, 6)
            || CharacterHasStateInfo(X0_4, 260)
            || (InArea(10000, 1043312340)
                && ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
                    || CharacterType(10000, TargetType.Alive)
                    || CharacterType(10000, TargetType.GrayPhantom)
                    || CharacterType(10000, TargetType.WhitePhantom))));
    SetCharacterAIState(X0_4, Enabled);
    if (!InArea(10000, 1043312339)) {
        SetSpEffect(1043310341, 7171); // Make the 'to be crushed commoner' low health
        ForceAnimationPlayback(1043310340, 20016, false, true, false, Equal, 1);
        SetCharacterHome(1043310340, 1043312341);
    }
});

// Shrine Initialization
$Event(1043312310, Restart, function(X0_4) {
    //SetEventFlagID(TrollOTK, OFF); // EVENT TESTER TROLL
    //SetEventFlagID(BossEncountered, OFF); // EVENT TESTER BOSS ENTERANCE
    //SetEventFlagID(1043317420, OFF); // EVENT TESTER SHINY AMBUSH
    //SetEventFlagID(ShrineComplete, OFF); // EVENT TESTER SHRINE
    //SetEventFlagID(1043318694, OFF); // EVENT TESTER DOOR
    //SetEventFlagID(1043317410, OFF); // EVENT TESTER REWARD
    
    // If the shrine has already been absorbed
    GotoIf(L0, EventFlag(ShrineComplete));
    
    // Basic Setup
    DisableNetworkSync();
    EnableCharacterDefaultBackread(X0_4);
    DisableCharacterGravity(X0_4);
    
    // Arena SFX (needs a lotta time)
    WaitFor(InArea(10000, 1043310949));
    InitializeEvent(0, 1043311713, 1);
    
    // Anim
    WaitFor(ActionButtonInArea(9100, 1043310922));
    SetEventFlagID(1043312949, ON);
    RotateCharacter(10000, 1043310920, -1, true);
    ForceAnimationPlayback(10000, 60550, false, false, false, Equal, 1);
    
    // Pocket Dimension Prep
    if (!CharacterDead(1043310800)) {
        ChangeWeather(Weather.Fog, -1, false);
        WaitFixedTimeSeconds(1.5);
        FadeToBlack(1, 0.8, false, -1);
        WaitFixedTimeSeconds(1);
        
        // Pocket Dimension Teleport
        IssueShortWarpRequest(10000, TargetEntityType.Area, 43312851, -1);
        SetPlayerPositionDisplay(Enabled, false, 60, 43, 31, 0, -25, -185, -25);
        SetCameraAngle(1, -135);
        
        // Yellow phantom on player
        SetSpEffect(10000, 360950);
        
        SetCurrentTime(0, 0, 0, false, false, false, 0, 0, 0);
        FreezeTime(true);
        WaitFixedTimeSeconds(2);
        FadeToBlack(0, 0.8, false, -1);
        
        // Boss Defeat Handling
        WaitFor(CharacterDead(1043310800));
        SetEventFlagID(1043312267, OFF); // Special Clause #1 - In case of boss instakilled
        SetEventFlagID(1043312265, OFF); // Special Clause #2 - In case of boss instakilled
        SetEventFlagID(1043312260, ON); //music handler - boss death
        SetEventFlagID(1043312266, OFF); //temp flag for 2nd phase OFF
        WaitFixedTimeSeconds(2);
        ForceCharacterDeath(1043310921, false); // Disable BulletDummy
        WaitFixedTimeSeconds(4);
        SetEventFlagID(1043312260, OFF); //music handler - boss death
        FreezeTime(false);
        ChangeWeather(Weather.Rain, -1, false);
        ReproduceAssetAnimation(1043311930, 1);
        WarpCharacterAndCopyFloorWithFadeout(10000, TargetEntityType.Area, 43312852, -1, 10000, false, true);
        SetPlayerPositionDisplay(Enabled, false, 60, 43, 31, 0, 40, 33, -1);
        WaitFixedTimeFrames(55);
        
        // Yellow phantom off player
        ClearSpEffect(10000, 360950);
        WaitFixedTimeFrames(15);
    }
    else {
        ChangeWeather(Weather.Rain, -1, false);
        ForceCharacterDeath(1043310921, false); // Disable BulletDummy
        WaitFixedTimeFrames(45);
    }
    
    // SFX
    DeleteMapSFX(1043310920, false); // Remove Orb
    SpawnOneshotSFX(TargetEntityType.Area, 1043310920, 100, 450282); // Orb explodes
    InitializeEvent(0, 1043311713, 0); // Remove Arena SFX
    InitializeEvent(0, 1043312311, 0); // Gradually delete fire
    
    // Award and flag
    WaitFixedTimeSeconds(0.6);
    HandleBossDefeatAndDisplayBanner(1043310800, TextBannerType.EnemyFelled);
    AwardItemLot(1043310410);
    SetEventFlagID(ShrineComplete, ON);
    SetEventFlagID(9273, ON);
    EndEvent();
L0:
    // In case event was already completed
    ForceCharacterDeath(1043310921, false);
    ReproduceAssetAnimation(1043311930, 1);
    DeleteMapSFX(1043310920, false);
    InitializeEvent(0, 1043311713, 0); // Remove Arena SFX
    InitializeEvent(0, 1043312311, 1); // Instantly delete fire
    EndEvent();
});

// Gradual/Instant Fire Removal
$Event(1043312311, Restart, function(X0_4) {
    for (let i = 1; i <= 14; i++) {
        if (X0_4 == 0) // Gradual
            WaitFixedTimeFrames(10 + (i * 2));
        DeleteMapSFX(1043310930 + i, false);
    }
});

// Frenzy Door Teleporter
$Event(1043312312, Restart, function() {
    CreateAssetfollowingSFX(1043311931, 200, 806870);
    IfActionButtonInArea(MAIN, 9140, 1043311931);
    RotateCharacter(10000, 1043311931, -1, true);
    ForceAnimationPlayback(10000, 60490, false, false, false, Equal, 1);
    WaitFixedTimeSeconds(3);
 
    WarpPlayer(60, 38, 48, 0, 1038482660, 60);
    SaveRequest();
    SetPlayerRespawnPoint(1038482660);
    RestartEvent();
});

// Apply scaling and enable madness bullets
$Event(1043312320, Restart, function(X0_4, X4_4) {
    if (X4_4 == 0) {      
        if (GameCycle() == 0) {
            SetSpEffect(X0_4, 16630);
            EndEvent();
        }
        if (GameCycle() == 1) {
            SetSpEffect(X0_4, 16631);
            EndEvent();
        }
        if (GameCycle() == 2) {
            SetSpEffect(X0_4, 16632);
            EndEvent();
        }
        if (GameCycle() == 3) {
            SetSpEffect(X0_4, 16633);
            EndEvent();
        }
        if (GameCycle() == 4) {
            SetSpEffect(X0_4, 16634);
            EndEvent();
        }
        if (GameCycle() == 5) {
            SetSpEffect(X0_4, 16635);
            EndEvent();
        }
        if (GameCycle() == 6) {
            SetSpEffect(X0_4, 16636);
            EndEvent();
        }
        if (GameCycle() >= 7) {
            SetSpEffect(X0_4, 16637);
            EndEvent();
        }
    }
    else {
        SetSpEffect(X0_4, 16637);
        EndEvent();
    }        
});

// Post BossFight Entertance
$Event(1043311711, Restart, function() {
    if (!EventFlag(ShrineComplete)) {
        DeleteMapSFX(1043311712, false);
        DisableAsset(1043311713);
    
        WaitFor(EventFlag(ShrineComplete));
        SpawnMapSFX(1043311712);
        EnableAsset(1043311713);
    }
    
    WaitFor(InArea(10000, 1043311711));
    //WarpCharacterAndCopyFloorWithFadeout(10000, TargetEntityType.Area, 43312852, -1, 10000, false, true);
    //SetPlayerPositionDisplay(Enabled, false, 60, 43, 31, 0, 40, 33, -1);
    WarpCharacterAndCopyFloorWithFadeout(10000, TargetEntityType.Area, 43312851, -1, 10000, false, true);
    SetPlayerPositionDisplay(Enabled, false, 60, 43, 31, 0, -25, -185, -25);
    
    InitializeEvent(0, 1043311713, 1);
    ChangeWeather(Weather.Fog, -1, false);
    SetCurrentTime(0, 0, 0, true, false, false, 0, 0, 0);
    FreezeTime(true);
    
    WaitFixedTimeFrames(80);
    SetSpEffect(10000, 360950); 
});

// 920700
// 921600
const BGM = 921600

// Pocket Dimension Boss Initialization
$Event(1043311712, Restart, function() {
    InitializeEvent(0, 1043311713, 0); // Remove Arena SFX
    //InitializeCommonEvent(0, 9005822, 1043310800, 921600, 1043312265, 1043312265, 0, 1043312266, 0, 0);
    
    if (EventFlag(ShrineComplete)) {
        // Boss
        DisableCharacter(1043310800);
        DisableCharacterCollision(1043310800);
        ForceCharacterDeath(1043310800, false);
        // Outer Core
        DisableCharacter(1043310922);
        DisableCharacterCollision(1043310922);
        ForceCharacterDeath(1043310922, false);
        // Inner Core
        DisableCharacter(1043310923);
        DisableCharacterCollision(1043310923);
        ForceCharacterDeath(1043310923, false);
        
        EndEvent();
    }
    
    DisableCharacterAI(1043310800);
    DisableCharacterGravity(1043310924);
    SetSpEffect(1043310800, 4301); // Fade out after death
    
    EnableCharacterDefaultBackread(1043310922);
    EnableCharacterDefaultBackread(1043310923);
    DisableCharacterGravity(1043310922);
    DisableCharacterGravity(1043310923);
    InitializeEvent(0, 1043311714, 1043310922, 1043310830); // Outer core damage
    InitializeEvent(1, 1043311714, 1043310923, 1043310831); // Inner core damage
    
    if (!EventFlag(BossEncountered)) {
        //DisableCharacter(1043310800);
        ForceAnimationPlayback(1043310800, 703, true, false, false, Equal, 1);
        dmg = HasDamageType(1043310800, 10000, DamageType.Unspecified);
        WaitFor(
            PlayerIsInOwnWorld() && InArea(10000, 43311712)
            || dmg);
            
        if (!dmg.Passed)
            WaitFixedTimeSeconds(8.5);
        SetNetworkconnectedEventFlagID(BossEncountered, ON);
        
        //EnableCharacter(1043310800);
        ForceAnimationPlayback(1043310800, 20004, false, false, false, Equal, 1);
        SetEventFlagID(1043312265, ON);
        SetBossBGM(BGM, BossBGMState.Start);
        //WaitFixedTimeFrames(75);
        EnableCharacterAI(1043310800);
        SetNetworkUpdateRate(1043310800, true, CharacterUpdateFrequency.AlwaysUpdate);
    }
    else {
        WaitFor(InArea(10000, 43311712));
        WaitFixedTimeSeconds(4);
        SetEventFlagID(1043312265, ON);
        SetBossBGM(BGM, BossBGMState.Start);
        EnableCharacterAI(1043310800);
        SetNetworkUpdateRate(1043310800, true, CharacterUpdateFrequency.AlwaysUpdate);
        WaitFixedTimeSeconds(2.5);
    }
    
    if (!CharacterDead(1043310800)) {
        DisplayBossHealthBar(Enabled, 1043310800, 0, 904140305);
        //SetEventFlagID(1043312265, ON);
        //SetBossBGM(BGM, BossBGMState.Start);
        TriggerAISound(6203, 10000, TargetEntityType.Area);
        
        InitializeEvent(0, 1043311717, 0); // Second Phase handler
        WaitFor(CharacterDead(1043310800));
        SetEventFlagID(1043310800, ON);
        //WaitFixedTimeSeconds(2);
        SetBossBGM(BGM, BossBGMState.Stop2);
    }

    // Outer Core
    DisableCharacter(1043310922);
    DisableCharacterCollision(1043310922);
    ForceCharacterDeath(1043310922, false);
    // Inner Core
    DisableCharacter(1043310923);
    DisableCharacterCollision(1043310923);
    ForceCharacterDeath(1043310923, false);
});

// Spawn or despawn arena SFX
$Event(1043311713, Restart, function(X0_4) {
    if (X0_4 == 0) {
        for (let i = 1; i <= 13; i++) {
            DeleteMapSFX(1043310949 + i, false);
        }
    }
    else {
        for (let i = 1; i <= 13; i++) {
            SpawnMapSFX(1043310949 + i);
            WaitFixedTimeRealFrames(30); // Otherwise it lags
        }
    }
});

// Arena Eye Core Damage Toggle
$Event(1043311714, Restart, function(X0_4, X4_4) {
    stop = EventFlag(ShrineComplete);
    DisableCharacter(X0_4);
    SetNetworkUpdateRate(X0_4, true, CharacterUpdateFrequency.NoUpdate);
    EndIf(stop);
    
    WaitFor(InArea(10000, X4_4) || stop);
    EndIf(stop.Passed);
    EnableCharacter(X0_4);
    SetNetworkUpdateRate(X0_4, true, CharacterUpdateFrequency.AlwaysUpdate);
    
    WaitFor(!InArea(10000, X4_4) || stop)
    RestartEvent();
});

// Shoot 1~3 bullets from a cloud
$Event(1043311715, Restart, function() {
    EndIf(CharacterDead(1043310800)); 
    
    // Shoot 3 bullets out of 1~3 cloud(s)
    InitializeEvent(0, 1043311716, 0);
    InitializeEvent(1, 1043311716, 0);
    InitializeEvent(2, 1043311716, 0);
    
    WaitFixedTimeSeconds(1);    
    RestartEvent();
});

// Shoot bullet out of random cloud
$Event(1043311716, Restart, function() {
    RandomlySetEventFlagInRange(1043310423, 1043310430, ON);
    for (let i = 0; i < CloudCount; i++) {
        ShootBullet(1043310924, 1043310964 + i, -1, 160, 0, 0, 0);
    }
    BatchSetEventFlags(1043310423, 1043310430, OFF);
});

// Second Phase Handler
$Event(1043311717, Restart, function() {
    EndIf(EventFlag(ShrineComplete));
    WaitFor(CharacterHasSpEffect(1043310800, 19955));
    EndIf(CharacterDead(1043310800));
    SetEventFlagID(1043312267, ON);
    WaitFor(CharacterHasSpEffect(1043310800, 15530));
    EndIf(CharacterDead(1043310800));
    SetBossBGM(BGM, BossBGMState.HeatUp);
    SetEventFlagID(1043312267, OFF);
    SetEventFlagID(1043312265, OFF); //temp flag for boss start OFF
    SetEventFlagID(1043312266, ON);
    
    EndIf(DisableCloudPhase == 1);
    for (let i = 0; i < CloudCount; i++) {
        SpawnMapSFX(1043310965 + i);
        CreateAssetfollowingSFX(1043310965 + i, -1, 7193010);
        //WaitFixedTimeRealFrames(30); // Otherwise it lags
    }
    WaitFixedTimeSeconds(1.5);
    CreateBulletOwner(1043310924);
    InitializeEvent(0, 1043311715, 0);
});

// - - Madness Cliff (Beach) - - 

// Bloated guys ambush
$Event(1043311530, Restart, function(X0_4, X4_4) {
    EndIf(EventFlag(1043317420))

    SetCharacterGravity(X0_4, Disabled);
    SetCharacterMaphit(X0_4, false);
    DisableCharacterAI(X0_4);
    
    WaitFor(EventFlag(1043317420));
    WaitFixedTimeFrames(X4_4);
    
    SetCharacterGravity(X0_4, Enabled);
    SetCharacterMaphit(X0_4, true);
    EnableCharacterAI(X0_4);
    
    ForceAnimationPlayback(X0_4, 20000, false, false, false);
});

// Does not open from this side msg - frenzy
$Event(1043311695, Restart, function() {
    evnt = EventFlag(1043318694);
    EndIf(evnt);
    WaitFor(evnt || ActionButtonInArea(8100, 1043311695));
    EndIf(evnt.Passed);
    DisplayGenericDialog(4010, PromptType.OKCANCEL, NumberofOptions.NoButtons, 0, 1);
    RestartEvent();
});

// Does not open from this side msg - morne tunnel
$Event(1043310877, Restart, function() {
    IfActionButtonInArea(MAIN, 8100, 1043310877);
    if (EventFlag(32000800))
    {
        IssueShortWarpRequest(10000, TargetEntityType.Asset, 1043310877, 121);
        WaitFixedTimeFrames(1);
        RotateCharacter(10000, 1043310877, -1, true);
        ForceAnimationPlayback(10000, 60030, false, false, false, Equal, 1);
        WaitFixedTimeFrames(80);
        WarpPlayer(32, 0, 0, 0, 1032000876, 60);
        RestartEvent();
    }
    DisplayGenericDialog(4010, PromptType.OKCANCEL, NumberofOptions.NoButtons, 0, 1);
    RestartEvent();
});

$Event(1043310949, Restart, function() {
    EndIf(EventFlag(ShrineComplete));
    WaitFor(InArea(10000, 1043310949) && !EventFlag(1043312949));
    
    SetEventFlagID(1043318949, ON);
    
    WaitFor(!InArea(10000, 1043310949) || InArea(10000, 43311712) || EventFlag(1043312949));
    SetEventFlagID(1043318949, OFF);
    RestartEvent();
});

$Event(1043310950, Restart, function() {
    EndIf(EventFlag(ShrineComplete));
    
    DisableCharacter(1043310921);
    SetNetworkUpdateRate(1043310921, true, CharacterUpdateFrequency.NoUpdate);
    
    WaitFor(EventFlag(1043318949));
    EnableCharacter(1043310921);
    SetNetworkUpdateRate(1043310921, true, CharacterUpdateFrequency.AlwaysUpdate);
    
    WaitFor(!EventFlag(1043318949))
    RestartEvent();
});

// Madness ground fire damage handler
$Event(1043310955, Restart, function(X0_4) {
    CreateBulletOwner(1043310925);
    ShootBullet(1043310925, X0_4, -1, 170, 0, 0, 0);
    WaitFixedTimeSeconds(0.6);
    RestartEvent();
});

// - - - Morne Interior - - - 

// Erdtree Door Puzzle
$Event(1043301810, Default, function() {
    GotoIf(L0, EventFlag(1043300720) && EventFlag(1043300721));
    CreateAssetfollowingSFX(1043301811, 101, 1540)
    WaitFor(EventFlag(1043300720) && EventFlag(1043300721));
    WaitFixedTimeFrames(25);
    DisplayBlinkingMessage(4205);
    DeleteAssetfollowingSFX(1043301811, false);
L0:
    DisableAsset(1043301810);
    DisableAsset(1043301811);
});

// Erdtree Door Puzzle Braziers - Asset, Flag, VFX North
$Event(1043301811, Default, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_0, X36_4) {
    GotoIf(L0, EventFlag(X4_4));
    
    WaitFor(ActionButtonInArea(9534, X0_4));
    RotateCharacter(10000, X0_4, -1, true);
    ForceAnimationPlayback(10000, 60550, false, false, false, Equal, 1);
    WaitFixedTimeFrames(70);
    SetEventFlagID(X4_4, ON);
L0:
    // Deactivate Shrine VFX
    DeleteMapSFX(X8_4, true);
    DeleteMapSFX(X12_4, true);
    DeleteMapSFX(X16_4, true);
    DeleteMapSFX(X20_4, true);
    // Activate Door VFX
    SpawnMapSFX(X24_4);
    SpawnMapSFX(X28_4);
    SpawnMapSFX(X32_0);
    SpawnMapSFX(X36_4);
});

// Inner Wall GÃ¶lem
$Event(1043312345, Restart, function() {
    DisableCharacterAI(1043312345);
    WaitFor(InArea(10000, 1043312342) || InArea(10000, 1043312343) || InArea(10000, 1043312344) || InArea(10000, 1043312346) || InArea(10000, 1043312347));
    EnableCharacterAI(1043312345);
    WaitFor(!InArea(10000, 1043312342) && !InArea(10000, 1043312343) && !InArea(10000, 1043312344) && !InArea(10000, 1043312346) && !InArea(10000, 1043312347));
    RestartEvent();
})

// Fire Balista
$Event(1043310330, Restart, function() {
    DisableCharacterAI(1043310330);
    WaitFor(InArea(10000, 1043312218) || InArea(10000, 1043312213) || InArea(10000, 1043312219));
    EnableCharacterAI(1043310330);
    WaitFor(!InArea(10000, 1043312218) && !InArea(10000, 1043312213) && !InArea(10000, 1043312219));
    RestartEvent();
})

// Spire chest handler
$Event(1043313905, Default, function() {
    EndIf(EventFlag(1043318675));
    SetObjactState(1043311905, -1, Disabled);
    
    hasItem |= PlayerHasItem(ItemType.Goods, 8135);
    WaitFor(hasItem || ActionButtonInArea(8000, 1043311905))
    
    if (!hasItem.Passed) {
        DisplayGenericDialog(4015, PromptType.YESNO, NumberofOptions.NoButtons, 10000, 1);
        WaitFixedTimeSeconds(1);
        RestartEvent();
    }
    
    SetObjactState(1043311905, -1, Enabled);
    WaitFor(EventFlag(1043318675));
    DisplayGenericDialog(4016, PromptType.YESNO, NumberofOptions.NoButtons, 10000, 1);
})

// Frenzy Shrine Immunity
$Event(1043313906, Default, function() {
    EndIf(EventFlag(ShrineComplete));
    WaitFor(
        !CharacterHasSpEffect(10000, 312700) && // Clarifying Horn Charm
        !CharacterHasSpEffect(10000, 511051) && // Purifying Crystal Tear
        !CharacterHasSpEffect(10000, 1738000) && // Heart of Chaos
        !CharacterHasSpEffect(10000, 7001100) // Tarnished Endurance (Scaled Armor)
    );
    SetSpEffect(10000, 10236);
    WaitFor(
        CharacterHasSpEffect(10000, 312700) || // Clarifying Horn Charm
        CharacterHasSpEffect(10000, 511051) || // Purifying Crystal Tear
        CharacterHasSpEffect(10000, 1738000) || // Heart of Chaos
        CharacterHasSpEffect(10000, 7001100) // Tarnished Endurance (Scaled Armor)
    );
    ClearSpEffect(10000, 10236);
    RestartEvent();
})
